<div class="m-3">
  <div class="container">
    <div class="col-12 d-flex justify-content-center">
      <div class='col-12 my-5'>
        <%# CAS: challenge terminÃ© // DONE %>
        <% if @challenge.started %>
          <% if @challenge.end_date < Date.today %>
              <div class="w-200 text-center my-5">
                <h2>Le challenge "<%= @challenge.title %>" s'est terminÃ© le <%= @challenge.end_date %></h2>
            <div class="card2 mt-5">
                <h6>DurÃ©e totale : <%= @challenge.total_time %> jours.</h6>
                <p>ðŸŽ‰ Tu as effectuÃ© <%= @progression_count_current_user %> jours de challenge, et remportÃ© <%= @total_points_count %> points! ðŸŽ‰</p>
              </div>
              <p class="mt-4"><em>Nostalgique ? Tu peux toujours refaire ce challenge ou en crÃ©er un autre <%= link_to "ici", new_challenge_path %>!<em></p>
            </div>
          <% else %>

        <%# CAS: challenge lancÃ©, en cours %>
        <div class='challenge-description'>
          <div class="card2 my-4">
            <h1 class="text-center">"<%= @challenge.title.capitalize %>" est lancÃ©!</h1>
            <p>Wouhou! Tu participes actuellement Ã  ce challenge ðŸš€</p>
          </div>
            <p>"<%= @challenge.description %>"</p>
            <p class="text-center mb-3"><em>Wow, quelle description...</em></p>
          <div class="card2 my-4">
            <h4>Score des participantÂ·eÂ·s</h4>
              <ul class="text-left">
                <% @users.each do |user| %>
                <li><%= cl_image_tag user.photo.key, height: 200, width: 200, crop: :fill, id:"avatar" %> <strong><%= user.name %>: </strong></li>
                <li class="ms-5"><% @participations.each do |participation| %>
                    <% if participation.user_id == user.id %>
                      <% @progression_count = 0 %>
                      <% participation.progressions.each do |progression| %>
                        <% if progression.done %>
                          <% @progression_count += progression.points %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <%= @progression_count %> points</li>
                <% end %>
              <% end %>
              </ul>
              <ul>
                <% @users.each do |user| %>
                  <% @participations.each do |participation| %>
                    <% if participation.user_id == user.id %>
                      <% @progression_count = 0 %>
                      <% participation.progressions.each do |progression| %>
                        <% if progression.done %>
                          <% @progression_count += 1 %>
                        <% end %>
                      <% end %>
                    <% end %>
                    <div>
                      <% ratio = @progression_count*100/@challenge.total_time%>
                      <%= image_tag "#{ratio.round(-1)}.svg" %>
                      <%= @progression_count %> jours - <%= user.name %>
                    </div>
                  <% end %>
                <% end %>
              </ul>
            </div>
          </div>
          <p><strong>Date de fin:</strong> <em><%= @challenge.end_date %></em>,<br>Il te reste <%= @time_left %> jours pour te surpasser!</p>
        <% end %>
      <% else %>

      <%# CAS: challenge prÃªt Ã  Ãªtre lancÃ©, invitation amis %>
        <h2 id="title", class="text-center mb-3" data-challenge="<%= @challenge.title %>">
          "<%= @challenge.title %>" est prÃªt Ã  Ãªtre lancÃ©!
        </h2>
        <p>PlutÃ´t ambitieux... PrÃªt Ã  rÃ©colter des points?</p>
        <p
          id="debut"
          data-challenge-debut="<%= @challenge.total_time %>"
          data-challenge-time-left="<%= @time_left %>">
          <strong>DÃ©but:</strong> <%= @challenge.start_date %>,<br><strong>DurÃ©e:</strong> <%= @challenge.total_time %> jours.
        </p>
      <div class="card2">
        <p><strong>Description</strong></p>
        <p><%= @challenge.description %></p>
        <% if current_user == @creator %>
          <div data-controller="share" data-share-id-value= <%= @challenge.id %>  data-share-title-value= <%= @challenge.title %> data-share-creator-value= <%= @creator.name %>>
            <p class= "btn btn-primary" data-action="click->share#shareLink"> Invite tes potes! </p>
          </div>
      </div>
      <br>
      <br>
      <div class="card2">
        <div class="enter-challenge">
          <div data-controller='enter-challenge'
            data-enter-challenge-target="card-enter"
            data-enter-challenge-create-url-value= "<%= participations_path %>"
            data-enter-challenge-user-id-value= "<%= current_user.id %>"
            data-enter-challenge-challenge-id-value= "<%= @challenge.id %>">
        <% else %>

        <%# CAS: invation reÃ§ue au challenge %>
        <h2 id="title", class="text-center mb-3" data-challenge="<%= @challenge.title %>">
          "<%= @challenge.title %>" est prÃªt Ã  Ãªtre lancÃ©!
        </h2>
          <div class="card2 my-4 text-center">
            <p>Veux-tu y participer?</p>
            <button id="launch" class="btn btn-primary" data-action="click->enter-challenge#accept">
              Let's go!
            </button>
            <button class="btn btn-primary" data-action="click->enter-challenge#refuse">
              Nope
            </button>
          </div>
        </div>
      </div>
    <% end %>
      <h5>ParticipantÂ·eÂ·s validÃ©s:</h5>
      <p><em>Tout le monde est la? Lance le challenge!</em></p>
      <% @users.each do |user| %>
        <ul class="text-left in-line">
          <li><%= cl_image_tag user.photo.key, height: 200, width: 200, crop: :fill, id:"avatar" %> <strong><%= user.name %></strong></li>
        </ul>
      <% end %>
    <div>

      <%# CAS: bouton "lancer le challenge" %>
        <% if current_user == @creator %>
          <div data-controller="started"
            data-started-update-url-value="<%=  started_challenge_path(@challenge) %>">
            <button id="launch2" class="btn mt-4 btn-primary" data-action="click->started#status">
              C'est parti !ðŸš€
            </button>
          </div>
        <% end %>
      </div>
      <% end %>
    </div>
  </div>
</div>
